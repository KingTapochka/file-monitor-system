<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Fragment>
    
    <!-- Компоненты клиентской части (FileMonitorApp) - Self-Contained Single File -->
    <ComponentGroup Id="ClientComponents" Directory="CLIENT_DIR">
      
      <!-- Основной EXE файл (self-contained, включает все зависимости) -->
      <Component Id="ClientExeComponent" Guid="{66666666-6666-6666-6666-666666666661}" Bitness="always64">
        <File Id="ClientExeFile" 
              Source="..\FileMonitorApp\bin\Release\publish\FileMonitorApp.exe" 
              KeyPath="yes" />
      </Component>

      <!-- Конфигурация -->
      <Component Id="ClientConfigComponent" Guid="{88888888-8888-8888-8888-888888888888}" Bitness="always64">
        <File Id="ClientConfigFile" 
              Source="..\FileMonitorApp\bin\Release\publish\FileMonitorApp.dll.config" 
              KeyPath="yes" />
      </Component>

      <!-- Иконка приложения -->
      <Component Id="AppIconComponent" Guid="{77777777-7777-7777-7777-777777777777}" Bitness="always64">
        <File Id="AppIconFile" Source="..\FileMonitorApp\app-dark-v2.ico" KeyPath="yes" />
      </Component>

    </ComponentGroup>

    <!-- Компонент регистрации и SendTo -->
    <DirectoryRef Id="CLIENT_DIR">
      <Component Id="ClientRegistrationComponent" Guid="{99999999-9999-9999-9999-999999999999}" Bitness="always64">
        <CreateFolder />
        
        <!-- Регистрация в реестре -->
        <RegistryKey Root="HKLM" Key="SOFTWARE\FileMonitorSystem">
          <RegistryValue Type="string" Name="ClientPath" Value="[CLIENT_DIR]" KeyPath="yes" />
          <RegistryValue Type="string" Name="Version" Value="3.4.1.0" />
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- Автозапуск клиента при входе пользователя -->
    <DirectoryRef Id="CLIENT_DIR">
      <Component Id="ClientAutoStartComponent" Guid="{CCCCCCCC-CCCC-CCCC-CCCC-CCCCCCCCCCCC}" Bitness="always64">
        <RegistryKey Root="HKCU" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run">
          <RegistryValue Type="string" Name="FileMonitor" Value="[CLIENT_DIR]FileMonitorApp.exe" KeyPath="yes" />
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- Контекстное меню Windows - пункт "Проверка файла" для всех файлов -->
    <DirectoryRef Id="CLIENT_DIR">
      <Component Id="ContextMenuComponent" Guid="{DDDDDDDD-DDDD-DDDD-DDDD-DDDDDDDDDDDD}" Bitness="always64">
        <RegistryKey Root="HKLM" Key="SOFTWARE\Classes\*\shell\FileMonitor.CheckFile">
          <RegistryValue Type="string" Value="Проверка файла" />
          <RegistryValue Type="string" Name="Icon" Value="[CLIENT_DIR]FileMonitorApp.exe,0" />
        </RegistryKey>
        <RegistryKey Root="HKLM" Key="SOFTWARE\Classes\*\shell\FileMonitor.CheckFile\command">
          <RegistryValue Type="string" Value="&quot;[CLIENT_DIR]FileMonitorApp.exe&quot; &quot;%1&quot;" KeyPath="yes" />
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- Ярлык в меню Пуск -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ProgramMenuDir" Name="File Monitor">
        <Component Id="StartMenuShortcutComponent" Guid="{AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAAAA}">
          <Shortcut Id="StartMenuShortcut"
                    Name="File Monitor"
                    Description="Проверка использования файлов"
                    Target="[CLIENT_DIR]FileMonitorApp.exe"
                    WorkingDirectory="CLIENT_DIR"
                    Icon="AppIconDark.ico" />
          <RemoveFolder Id="RemoveProgramMenuDir" On="uninstall" />
          <RegistryValue Root="HKCU" Key="Software\FileMonitorSystem" Name="StartMenuInstalled" Type="integer" Value="1" KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Ярлык на рабочем столе -->
    <StandardDirectory Id="DesktopFolder">
      <Component Id="DesktopShortcutComponent" Guid="{BBBBBBBB-BBBB-BBBB-BBBB-BBBBBBBBBBBB}">
        <Shortcut Id="DesktopShortcut"
            Name="File Monitor"
            Description="Проверка использования файлов"
            Target="[CLIENT_DIR]FileMonitorApp.exe"
            WorkingDirectory="CLIENT_DIR"
            Icon="AppIconDark.ico" />
        <RegistryValue Root="HKCU" Key="Software\FileMonitorSystem" Name="DesktopInstalled" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </StandardDirectory>

    <!-- Определение иконки для ярлыков -->
    <Icon Id="AppIconDark.ico" SourceFile="..\FileMonitorApp\app-dark-v2.ico" />

  </Fragment>
</Wix>
