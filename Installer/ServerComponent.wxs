<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Fragment>
    
    <!-- Компоненты серверной части (Single-file deployment) -->
    <ComponentGroup Id="ServerComponents" Directory="SERVER_DIR">
      
      <!-- Основной исполняемый файл с установкой службы -->
      <Component Id="ServerExeComponent" Guid="{11111111-1111-1111-1111-111111111111}" Bitness="always64">
        <File Id="ServerExeFile" 
              Source="..\FileMonitorService\bin\Release\publish\FileMonitorService.exe" 
              KeyPath="yes" />
        
        <!-- Установка Windows Service -->
        <ServiceInstall
          Id="FileMonitorServiceInstall"
          Name="FileMonitorService"
          DisplayName="File Monitor Service"
          Description="Служба мониторинга использования файлов на файловом сервере. Порт 5000."
          Start="auto"
          Type="ownProcess"
          ErrorControl="ignore"
          Account="LocalSystem" />
        
        <!-- Управление службой: запуск после установки, остановка и удаление при деинсталляции -->
        <ServiceControl
          Id="FileMonitorServiceControl"
          Name="FileMonitorService"
          Start="install"
          Stop="both"
          Remove="uninstall"
          Wait="no" />
      </Component>

      <!-- Конфигурация appsettings.json -->
      <Component Id="ServerConfigComponent" Guid="{33333333-3333-3333-3333-333333333333}" Bitness="always64">
        <File Id="AppSettingsFile" 
              Source="..\FileMonitorService\bin\Release\publish\appsettings.json" 
              KeyPath="yes" />
      </Component>

      <!-- Sysinternals Handle для обнаружения всех открытых файлов (включая Adobe Acrobat) -->
      <Component Id="HandleExeComponent" Guid="{44444444-4444-4444-4444-444444444444}" Bitness="always64">
        <File Id="HandleExeFile" 
              Source="..\FileMonitorService\bin\Release\net8.0-windows\win-x64\handle64.exe" 
              KeyPath="yes" />
      </Component>

      <!-- Компонент для создания папок и реестра (внутри ServerComponents чтобы устанавливаться вместе с exe) -->
      <Component Id="ServerServiceComponent" Guid="{55555555-5555-5555-5555-555555555555}" Bitness="always64">
        <CreateFolder />
        
        <!-- Создание папки для логов -->
        <CreateFolder Directory="ServerLogsDir" />
        
        <!-- Регистрация в реестре -->
        <RegistryKey Root="HKLM" Key="SOFTWARE\FileMonitorSystem">
          <RegistryValue Type="string" Name="ServerPath" Value="[SERVER_DIR]" KeyPath="yes" />
          <RegistryValue Type="string" Name="Version" Value="4.2.0.0" />
        </RegistryKey>
      </Component>

    </ComponentGroup>

    <!-- Директория для логов (объявляется до использования в ComponentGroup) -->
    <DirectoryRef Id="SERVER_DIR">
      <Directory Id="ServerLogsDir" Name="logs" />
    </DirectoryRef>

  </Fragment>
</Wix>
