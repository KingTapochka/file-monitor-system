<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  
  <?define ProductVersion="2.1.0.0" ?>
  <?define ProductName="File Monitor System" ?>
  <?define Manufacturer="File Monitor" ?>
  <?define UpgradeCode="{12345678-1234-1234-1234-123456789012}" ?>

  <Package 
    Name="$(var.ProductName)" 
    Version="$(var.ProductVersion)" 
    Manufacturer="$(var.Manufacturer)"
    UpgradeCode="$(var.UpgradeCode)"
    Language="1049"
    Codepage="1251"
    InstallerVersion="500"
    Scope="perMachine">

    <SummaryInformation 
      Description="Система мониторинга использования файлов на Windows Server"
      Manufacturer="$(var.Manufacturer)"
      Keywords="File Monitor, SMB, Windows Service" />

    <!-- ===== АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ ===== -->
    <!-- MajorUpgrade автоматически находит предыдущие версии по UpgradeCode и заменяет их -->
    <!-- При обновлении: 1) Останавливается старая версия 2) Удаляются старые файлы 3) Устанавливаются новые -->
    <MajorUpgrade 
      AllowDowngrades="no"
      AllowSameVersionUpgrades="yes"
      DowngradeErrorMessage="Более новая версия [ProductName] уже установлена. Сначала удалите её."
      Schedule="afterInstallValidate" />

    <!-- Медиа -->
    <Media Id="1" Cabinet="FileMonitor.cab" EmbedCab="yes" CompressionLevel="high" />

    <!-- Свойства для настройки сервера -->
    <Property Id="SERVER_ADDRESS" Value="localhost" />
    <Property Id="SERVER_PORT" Value="5000" />
    
    <!-- Директории установки -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="File Monitor System">
        <Directory Id="SERVER_DIR" Name="Service" />
        <Directory Id="CLIENT_DIR" Name="Client" />
      </Directory>
    </StandardDirectory>

    <!-- Ссылки на компоненты -->
    <Feature Id="ProductFeature" Title="File Monitor System" Level="1" Display="expand">
      
      <Feature Id="ServerFeature" 
               Title="Серверная служба (FileMonitorService)" 
               Description="Windows Service для мониторинга открытых файлов на сервере. Устанавливайте на файловый сервер."
               Level="1"
               ConfigurableDirectory="SERVER_DIR">
        <ComponentGroupRef Id="ServerComponents" />
        <ComponentRef Id="ServerServiceComponent" />
      </Feature>

      <Feature Id="ClientFeature" 
               Title="Клиентское приложение (File Monitor App)" 
               Description="Приложение для проверки использования файлов. Работает из системного трея, поддерживает горячие клавиши Win+Shift+F."
               Level="1"
               ConfigurableDirectory="CLIENT_DIR">
        <ComponentGroupRef Id="ClientComponents" />
        <ComponentRef Id="ClientRegistrationComponent" />
        <ComponentRef Id="StartMenuShortcutComponent" />
        <ComponentRef Id="DesktopShortcutComponent" />
      </Feature>
      
    </Feature>

    <!-- Кастомные действия для службы -->
    
    <!-- Остановка службы (перед обновлением или удалением) -->
    <CustomAction Id="StopServerService" 
                  Directory="SERVER_DIR" 
                  ExeCommand="cmd.exe /c &quot;sc stop FileMonitorService 2>nul&quot;"
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Пауза для корректной остановки службы -->
    <CustomAction Id="WaitForServiceStop" 
                  Directory="SERVER_DIR" 
                  ExeCommand="cmd.exe /c &quot;timeout /t 3 /nobreak >nul&quot;"
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Установка службы (только при первой установке) -->
    <CustomAction Id="InstallServerService" 
                  Directory="SERVER_DIR" 
                  ExeCommand="cmd.exe /c &quot;sc query FileMonitorService >nul 2>&amp;1 || sc create FileMonitorService binPath=\&quot;[SERVER_DIR]FileMonitorService.exe\&quot; start=auto DisplayName=\&quot;File Monitor Service\&quot;&quot;"
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Запуск службы -->
    <CustomAction Id="StartServerService" 
                  Directory="SERVER_DIR" 
                  ExeCommand="cmd.exe /c &quot;sc start FileMonitorService&quot;"
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Удаление службы (только при полном удалении) -->
    <CustomAction Id="UninstallServerService" 
                  Directory="SERVER_DIR" 
                  ExeCommand="cmd.exe /c &quot;sc delete FileMonitorService 2>nul&quot;"
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Последовательность установки -->
    <InstallExecuteSequence>
      <!-- Остановка службы: при обновлении, переустановке или удалении -->
      <Custom Action="StopServerService" Before="InstallFiles" Condition="(&amp;ServerFeature=3) OR (&amp;ServerFeature=2) OR (REINSTALL)" />
      <Custom Action="WaitForServiceStop" After="StopServerService" Condition="(&amp;ServerFeature=3) OR (&amp;ServerFeature=2) OR (REINSTALL)" />
      
      <!-- Установка службы (если ещё не существует) -->
      <Custom Action="InstallServerService" After="InstallFiles" Condition="(&amp;ServerFeature=3) AND (NOT REMOVE=&quot;ALL&quot;)" />
      
      <!-- Запуск службы после установки или обновления -->
      <Custom Action="StartServerService" After="InstallServerService" Condition="(&amp;ServerFeature=3) AND (NOT REMOVE=&quot;ALL&quot;)" />
      
      <!-- Удаление службы только при полном удалении -->
      <Custom Action="UninstallServerService" Before="RemoveFiles" Condition="(REMOVE=&quot;ALL&quot;) AND (NOT UPGRADINGPRODUCTCODE)" />
    </InstallExecuteSequence>

  </Package>
</Wix>
