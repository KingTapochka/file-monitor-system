<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  
  <?define ProductVersion="2.2.0.0" ?>
  <?define ProductName="File Monitor System" ?>
  <?define Manufacturer="File Monitor" ?>
  <?define UpgradeCode="{12345678-1234-1234-1234-123456789012}" ?>

  <Package 
    Name="$(var.ProductName)" 
    Version="$(var.ProductVersion)" 
    Manufacturer="$(var.Manufacturer)"
    UpgradeCode="$(var.UpgradeCode)"
    Language="1049"
    Codepage="1251"
    InstallerVersion="500"
    Scope="perMachine">

    <SummaryInformation 
      Description="Система мониторинга использования файлов на Windows Server"
      Manufacturer="$(var.Manufacturer)"
      Keywords="File Monitor, SMB, Windows Service" />

    <!-- ===== АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ ===== -->
    <MajorUpgrade 
      AllowDowngrades="no"
      AllowSameVersionUpgrades="yes"
      DowngradeErrorMessage="Более новая версия [ProductName] уже установлена. Сначала удалите её."
      Schedule="afterInstallValidate" />

    <!-- Медиа -->
    <Media Id="1" Cabinet="FileMonitor.cab" EmbedCab="yes" CompressionLevel="high" />

    <!-- UI для выбора компонентов -->
    <ui:WixUI Id="WixUI_FeatureTree" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Custom Action: Запуск клиента после установки -->
    <CustomAction Id="LaunchClientApp" 
                  FileRef="ClientExeFile" 
                  ExeCommand="" 
                  Impersonate="yes" 
                  Return="asyncNoWait" />
    
    <InstallExecuteSequence>
      <Custom Action="LaunchClientApp" After="InstallFinalize" Condition="(&amp;ClientFeature=3) AND NOT REMOVE" />
    </InstallExecuteSequence>
    
    <!-- Директории установки -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="File Monitor System">
        <Directory Id="SERVER_DIR" Name="Service" />
        <Directory Id="CLIENT_DIR" Name="Client" />
      </Directory>
    </StandardDirectory>

    <!-- Ссылки на компоненты -->
    <Feature Id="ProductFeature" Title="File Monitor System" Level="1" Display="expand" 
             Description="Выберите компоненты для установки">
      
      <Feature Id="ServerFeature" 
               Title="Серверная служба" 
               Description="Windows Service для мониторинга открытых файлов. Устанавливайте ТОЛЬКО на файловый сервер!"
               Level="1000"
               AllowAbsent="yes"
               AllowAdvertise="no"
               ConfigurableDirectory="SERVER_DIR">
        <ComponentGroupRef Id="ServerComponents" />
        <ComponentRef Id="ServerServiceComponent" />
      </Feature>

      <Feature Id="ClientFeature" 
               Title="Клиентское приложение" 
               Description="Приложение для проверки кто открыл файл. Устанавливайте на рабочие станции пользователей."
               Level="1"
               AllowAbsent="yes"
               AllowAdvertise="no"
               ConfigurableDirectory="CLIENT_DIR">
        <ComponentGroupRef Id="ClientComponents" />
        <ComponentRef Id="ClientRegistrationComponent" />
        <ComponentRef Id="ClientAutoStartComponent" />
        <ComponentRef Id="StartMenuShortcutComponent" />
        <ComponentRef Id="DesktopShortcutComponent" />
      </Feature>
      
    </Feature>

  </Package>
</Wix>
