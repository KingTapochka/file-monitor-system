# ДИАГНОСТИКА И ЗАПУСК FILE MONITOR SYSTEM

## 🔴 НАЙДЕННЫЕ ПРОБЛЕМЫ:

### 1. Explorer "ломается" - Shell Extension неправильно зарегистрирован
**Причина:** Используется `regasm.exe` вместо правильного метода регистрации SharpShell  
**Решение:** Запустить скрипт регистрации

### 2. Служба установлена но не запущена
**Причина:** Требуются права администратора для запуска  
**Решение:** Запустить службу вручную

### 3. Не видно где проверить работу
**Причина:** Нет инструкций и тестовых скриптов  
**Решение:** Использовать созданные скрипты проверки

---

## ✅ ПОШАГОВОЕ РЕШЕНИЕ:

### ШАГ 1: Запустите PowerShell от имени АДМИНИСТРАТОРА

Щелкните правой кнопкой на **PowerShell** → **Запуск от имени администратора**

### ШАГ 2: Перейдите в папку проекта

```powershell
cd "C:\monitoring_polzovateley"
```

### ШАГ 3: Запустите комплексную проверку

```powershell
.\Scripts\Test-System.ps1
```

Этот скрипт:
- ✓ Проверит все файлы
- ✓ Запустит службу (если остановлена)
- ✓ Проверит API
- ✓ Покажет логи
- ✓ Проверит регистрацию Shell Extension
- ✓ Даст инструкции по тестированию

### ШАГ 4: Зарегистрируйте Shell Extension (если нужно)

```powershell
.\Scripts\Register-ShellExtension.ps1
```

Этот скрипт:
- Остановит Explorer
- Зарегистрирует FileMonitorClient.dll через regasm
- Перезапустит Explorer

⚠️ **ВАЖНО:** Explorer будет перезапущен (все окна закроются и откроются снова)

---

## 🧪 ПРОВЕРКА РАБОТЫ:

### Проверка сервера (API):

```powershell
# Проверка доступности API
Invoke-RestMethod -Uri "http://localhost:5000/api/files" -Method Get

# Открыть Swagger UI в браузере
Start-Process "http://localhost:5000/swagger"
```

### Проверка клиента (Shell Extension):

1. Откройте любую папку в **Windows Explorer**
2. Создайте тестовый файл (например, `test.txt`)
3. **Щелкните ПРАВОЙ кнопкой мыши** на файле
4. Найдите пункт **"Кто использует файл?"**
5. Должно появиться окно со списком пользователей

### Проверка логов службы:

```powershell
# Показать последние логи
Get-ChildItem "C:\Program Files\File Monitor System\Service\logs" | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | Get-Content -Tail 20
```

---

## 📋 ДОПОЛНИТЕЛЬНЫЕ СКРИПТЫ:

### Если нужно переустановить Shell Extension:

```powershell
# 1. Сначала удалить старую регистрацию
.\Scripts\Unregister-ShellExtension.ps1

# 2. Затем зарегистрировать заново
.\Scripts\Register-ShellExtension.ps1
```

### Если нужно перезапустить службу:

```powershell
Restart-Service -Name FileMonitorService
```

### Если нужно остановить службу:

```powershell
Stop-Service -Name FileMonitorService
```

---

## 🎯 ПРО GUI УСТАНОВЩИКА:

**Вопрос:** "У меня так и не появился GUI интерфейс"

**Ответ:** MSI установщик **ИМЕЕТ** стандартный Windows Installer GUI:
- ✓ Экран приветствия
- ✓ **Выбор компонентов** (галочки: Серверная служба / Клиентское расширение)
- ✓ Выбор папки установки
- ✓ Прогресс установки
- ✓ Завершение

Это **стандартный GUI**, который показывает Windows при запуске MSI.

**Если хотите КАСТОМНЫЙ GUI** с полями ввода (адрес сервера, порт):
- Это требует значительной работы с WiX 4
- Текущий подход: использовать параметры командной строки

```powershell
# Установка с параметрами
msiexec /i FileMonitorSetup.msi ADDLOCAL=ClientFeature SERVER_ADDRESS=192.168.1.100 SERVER_PORT=8080 /qb
```

---

## 🔧 НАСТРОЙКА АДРЕСА СЕРВЕРА В КЛИЕНТЕ:

После установки клиента, отредактируйте конфигурационный файл:

**Файл:** `C:\Program Files\File Monitor System\Client\FileMonitorClient.dll.config`

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <appSettings>
    <add key="ServerAddress" value="http://192.168.1.100:5000" />
  </appSettings>
</configuration>
```

Замените `192.168.1.100:5000` на адрес вашего сервера.

---

## 📊 АРХИТЕКТУРА СИСТЕМЫ:

```
┌─────────────────────────────────────────────────────────────┐
│                    WINDOWS SERVER                            │
│  ┌──────────────────────────────────────────────────┐       │
│  │  FileMonitorService (Windows Service)             │       │
│  │  - Мониторит открытые файлы через Get-SmbOpenFile│       │
│  │  - Кеширует результаты                            │       │
│  │  - Предоставляет Web API на порту 5000            │       │
│  └──────────────────────────────────────────────────┘       │
│         ▲                                                     │
│         │ HTTP API (GET /api/files?path=...)                │
│         │                                                     │
└─────────┼─────────────────────────────────────────────────────┘
          │
          │ Сеть
          │
┌─────────┼─────────────────────────────────────────────────────┐
│         │              WINDOWS CLIENT                          │
│  ┌──────▼──────────────────────────────────────────┐         │
│  │  FileMonitorClient (Shell Extension)             │         │
│  │  - Добавляет пункт в контекстное меню Explorer  │         │
│  │  - При клике запрашивает API сервера             │         │
│  │  - Показывает WPF окно со списком пользователей │         │
│  └──────────────────────────────────────────────────┘         │
│                                                                │
│  Пользователь: ПКМ на файл → "Кто использует файл?"         │
└────────────────────────────────────────────────────────────────┘
```

---

## 📝 БЫСТРАЯ СПРАВКА:

| Действие | Команда |
|----------|---------|
| Полная проверка системы | `.\Scripts\Test-System.ps1` |
| Регистрация Shell Extension | `.\Scripts\Register-ShellExtension.ps1` |
| Отмена регистрации | `.\Scripts\Unregister-ShellExtension.ps1` |
| Запуск службы | `Start-Service FileMonitorService` |
| Остановка службы | `Stop-Service FileMonitorService` |
| Перезапуск службы | `Restart-Service FileMonitorService` |
| Проверка API | `Invoke-RestMethod http://localhost:5000/api/files` |
| Swagger UI | `Start-Process http://localhost:5000/swagger` |
| Логи службы | `C:\Program Files\File Monitor System\Service\logs` |

---

## ⚠️ ВАЖНО:

1. **Все скрипты требуют прав администратора** (запускайте PowerShell от имени администратора)
2. **Explorer перезапустится** при регистрации Shell Extension (это нормально)
3. **Служба должна быть запущена** для работы API
4. **Клиент должен знать адрес сервера** (через конфиг файл)

---

## 🆘 ЕСЛИ ЧТО-ТО НЕ РАБОТАЕТ:

1. Запустите PowerShell **от имени администратора**
2. Выполните: `.\Scripts\Test-System.ps1`
3. Прочитайте вывод - он покажет что не работает
4. Следуйте инструкциям из вывода

Или напишите конкретную ошибку - помогу разобраться!
